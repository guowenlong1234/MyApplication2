import common from '@ohos.app.ability.common';
import Want from '@ohos.app.ability.Want';
import { BusinessError } from '@ohos.base';
import { AppModel, AppItem } from '../model/AppModel'
import { SearchDialog } from './SearchDialog'
import { DistributedDialog } from './DistributedDialog';
import { NotificationPanel } from './NotificationPanel';
import { VoiceDialog } from './VoiceDialog';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
@Entry
@Component
struct Index {
  private context = getContext(this) as common.UIAbilityContext;
  private model = new AppModel();
  notifyController: CustomDialogController = new CustomDialogController({
    builder: NotificationPanel({}),
    autoCancel: true,
    customStyle: true,
    alignment: DialogAlignment.TopEnd, // é å³ä¸Šè§’
    offset: { dx: 0, dy: 0 }
  });

  // è¯­éŸ³åŠ©æ‰‹æ§åˆ¶å™¨ (åº•éƒ¨å¼¹èµ·)
  voiceController: CustomDialogController = new CustomDialogController({
    builder: VoiceDialog({
      launchApp: (item: AppItem) => this.launchApp(item)
    }),
    autoCancel: true,
    customStyle: true,
    alignment: DialogAlignment.Bottom // é åº•éƒ¨
  });
  // 1. å®šä¹‰åº”ç”¨åˆ—è¡¨æ•°æ®
  @State appList: Array<AppItem> = [];
  searchController: CustomDialogController = new CustomDialogController({
    builder: SearchDialog({
      appList: $appList, // åŒå‘ç»‘å®šåº”ç”¨åˆ—è¡¨
      launchApp: (item: AppItem) => this.launchApp(item) // æŠŠå¯åŠ¨å‡½æ•°ä¼ è¿›å»
    }),
    autoCancel: true, // ç‚¹å‡»ç©ºç™½å¤„å…³é—­
    alignment: DialogAlignment.Center, // å±…ä¸­æ˜¾ç¤º
    customStyle: true // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼(å»æ‰é»˜è®¤çš„ç™½è‰²åœ†è§’èƒŒæ™¯)
  });
  // è¶…çº§ç»ˆç«¯æ§åˆ¶å™¨
  distController: CustomDialogController = new CustomDialogController({
    builder: DistributedDialog({}),
    autoCancel: true,
    customStyle: true, // å…¨å±æ²‰æµ¸å¼
    alignment: DialogAlignment.Center
  });
  // 2. å®šä¹‰æ—¶é—´çŠ¶æ€ (ä¿®å¤æ ‡é»„)
  @State currentTime: string = '12:00';
  @State currentDate: string = '2024/01/20';
  private timerId: number = -1;

  aboutToAppear() {
    // åŠ è½½åº”ç”¨ç™½åå•
    this.requestMicPermission();
    this.appList = this.model.getAppList();

    // åˆå§‹åŒ–æ—¶é—´å¹¶å¯åŠ¨å®šæ—¶å™¨
    this.updateTime();
    this.timerId = setInterval(() => {
      this.updateTime();
    }, 1000);
  }
  requestMicPermission() {
    let atManager = abilityAccessCtrl.createAtManager();
    try {
      atManager.requestPermissionsFromUser(this.context, ['ohos.permission.MICROPHONE'])
        .then((data) => {
          console.info('éº¦å…‹é£æƒé™ç”³è¯·æˆåŠŸ');
        })
        .catch((err: BusinessError) => {
          console.error('éº¦å…‹é£æƒé™ç”³è¯·å¤±è´¥: ' + JSON.stringify(err));
        });
    } catch (err) {
      console.error('æƒé™ç”³è¯·å¼‚å¸¸');
    }
  }

  aboutToDisappear() {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
    }
  }

  // æ›´æ–°æ—¶é—´é€»è¾‘
  updateTime() {
    let now = new Date();
    let hours = now.getHours().toString().padStart(2, '0');
    let minutes = now.getMinutes().toString().padStart(2, '0');
    this.currentTime = `${hours}:${minutes}`;
    this.currentDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
  }
  @Builder TaskbarItem(bundleName: string, icon: Resource): void {
    Column() {
      Image(icon)
        .width(26) // å›¾æ ‡åšå°ä¸€ç‚¹
        .height(26)
    }
    .width(40) // ç‚¹å‡»çƒ­åŒºå®½åº¦
    .height(40) // ç‚¹å‡»çƒ­åŒºé«˜åº¦
    .justifyContent(FlexAlign.Center)
    .borderRadius(4)
    // æ¨¡æ‹Ÿ hover æ•ˆæœï¼šç‚¹å‡»æ—¶å˜äº®
    .stateStyles({
      pressed: { .backgroundColor('rgba(255,255,255,0.1)') },
      normal: { .backgroundColor(Color.Transparent) }
    })
    .margin({ left: 2, right: 2 })
    .onClick(() => {
      if (bundleName === 'distributed') {
        // æ‰“å¼€è¶…çº§ç»ˆç«¯ç•Œé¢
        this.distController.open();
      } else {
        this.launchApp({ name: bundleName, label: 'TaskApp', icon: icon });
      }
    })
  }
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // 1. æ¡Œé¢èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundImage($r('app.media.wallpaper'))// ç¡®ä¿ä½ æœ‰ wallpaper å›¾ç‰‡ï¼Œæ²¡æœ‰å°±åˆ æ‰è¿™è¡Œç”¨ backgroundColor
        .backgroundImageSize(ImageSize.Cover)

      // 2. æ¡Œé¢å›¾æ ‡ç½‘æ ¼
      Column() {
        Grid() {
          ForEach(this.appList, (item: AppItem) => {
            GridItem() {
              Column() {
                Image(item.icon)
                  .width(60)
                  .height(60)
                  .borderRadius(12)
                  .margin({ bottom: 8 })// ç»™å›¾æ ‡åŠ ä¸ªæ·¡æ·¡çš„ç™½åº•ï¼Œé˜²æ­¢åœ¨æ·±è‰²å£çº¸ä¸Šçœ‹ä¸æ¸…
                  .backgroundColor('rgba(255,255,255,0.15)')
                  .padding(5)

                Text(item.label)
                  .fontSize(15)
                  .fontColor(Color.White)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              //     .shadow({ radius: 2, color: 'rgba(0,0,0,0.8)', offsetY: 1 }) // æ–‡å­—é˜´å½±ï¼Œæ›´æ¸…æ™°
               }
              .width(80)
              .height(100)
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.launchApp(item))
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsGap(15)
        .padding({ top: 40, left: 30, right: 30 })
        .height('85%')
      }
      .width('100%')
      .height('100%')

      // ================= 3. åº•éƒ¨ä»»åŠ¡æ  (Win10 é£æ ¼) =================
      Row() {
        // --- A. å·¦ä¾§æ ¸å¿ƒåŒº (å¼€å§‹ + æœç´¢) ---
        Row() {
          // 1. å¼€å§‹æŒ‰é’® (Windows å¾½æ ‡)
          Image($r('app.media.win11'))// å»ºè®®æ¢æˆ Windows å›¾æ ‡
            .width(24)
            .height(24)
            .margin({ left: 15, right: 15 })
            .onClick(() => {
              AlertDialog.show({ message: 'å¼€å§‹èœå•å°šæœªå¼€å‘\n(è¿™æ˜¯å¤§ä½œä¸šçš„æ‰©å±•é¡¹)' })
            })

          // 2. ä»¿ Win10 æœç´¢æ¡† (ç‚¹å‡»å¼¹å‡ºæœç´¢å¼¹çª—)
          Row() {
            Image($r('app.media.browser'))// è¿™é‡Œæš‚ç”¨æµè§ˆå™¨å›¾æ ‡ä»£æ›¿æœç´¢æ”¾å¤§é•œï¼Œæœ€å¥½æ‰¾ä¸ª ic_search
              .width(16).height(16)
              .margin({ right: 10 })
              .opacity(0.6)

            Text("åœ¨è¿™é‡Œè¾“å…¥ä½ è¦æœç´¢çš„å†…å®¹")
              .fontSize(12)
              .fontColor('#666')
          }
          .height(32) // æœç´¢æ¡†é«˜åº¦
          .width(220) // æœç´¢æ¡†å®½åº¦ (é•¿æ¡å½¢)
          .backgroundColor(Color.White) // ç™½è‰²èƒŒæ™¯
          .borderRadius(4) // Win10 æ˜¯å¾®åœ†è§’ï¼ŒWin11 æ˜¯å¤§åœ†è§’ï¼Œè¿™é‡Œè®¾ 4 æ¯”è¾ƒåƒ Win10
          .padding({ left: 10 })
          .alignItems(VerticalAlign.Center) // å†…å®¹å‚ç›´å±…ä¸­
          .onClick(() => {
            this.searchController.open(); // ç‚¹å‡»æ¡†ä½“ï¼Œè§¦å‘å¼¹çª—
          })
        }

        // --- B. å¸¸ç”¨åº”ç”¨æ  (ç´§è·Ÿæœç´¢æ¡†) ---
        Row() {
          // è¿™é‡Œçš„åº”ç”¨å›¾æ ‡ç¨å¾®å°ä¸€ç‚¹ï¼Œåƒä»»åŠ¡æ 
          Image($r('app.media.mic'))
            .width(26)  // è®¾ç½®åˆé€‚çš„å®½åº¦ï¼Œè·Ÿæ—è¾¹å›¾æ ‡å¯¹é½
            .height(26) // è®¾ç½®é«˜åº¦
            .margin({ left: 12 }) // ä¿æŒé—´è·
            .onClick(() => {
              this.voiceController.open();
            })
          Column() {
            Image($r('app.media.connect'))
              .width(28).height(28)
              .fillColor(Color.White) // å›¾æ ‡å˜ç™½
          }
          .width(44).height(44)
          .backgroundColor('#0A59F7') // é¸¿è’™è“åº•è‰²ï¼éå¸¸æ˜¾çœ¼ï¼
          .borderRadius(12) // åœ†è§’
          .justifyContent(FlexAlign.Center)
          .margin({ left: 10 })
          .shadow({ radius: 10, color: 'rgba(10, 89, 247, 0.5)' }) // è“è‰²å‘å…‰é˜´å½±
          .onClick(() => {
            this.distController.open();
          })
          // æ›¿æ¢åŸæ¥çš„ Text ä»£ç 


          this.TaskbarItem('com.ohos.settings', $r('app.media.settings'))
          this.TaskbarItem('com.ohos.filepicker', $r('app.media.icon'))
          this.TaskbarItem('ohos.samples.browser', $r('app.media.browser'))
          // åˆ†å¸ƒå¼ååŒæŒ‰é’®

        }
        .margin({ left: 10 })

        // --- C. å ä½ç¬¦ (æŠŠå³è¾¹çš„æŒ¤è¿‡å») ---
        Blank()

        // --- D. å³ä¾§çŠ¶æ€æ  (æ‰˜ç›˜åŒº) ---
        Row() {
          // å°ç®­å¤´
          Text("âˆ§").fontSize(14).fontColor(Color.White).margin({ right: 10 })

          // ç”µæ± /WiFi
          Text("ğŸ“¶").fontSize(16).fontColor(Color.White).margin({ right: 8 })
          Text("ğŸ”‹").fontSize(16).fontColor(Color.White).margin({ right: 10 })

          // æ—¶é—´æ—¥æœŸ (å‚ç›´æ’åˆ—)
          Column() {
            Text(this.currentTime).fontSize(12).fontColor(Color.White)
            Text(this.currentDate).fontSize(10).fontColor(Color.White)
          }
          .alignItems(HorizontalAlign.End)
        }
        .onClick(() => {
          this.notifyController.open(); // ç‚¹å‡»æ—¶é—´æ‰“å¼€é€šçŸ¥ä¸­å¿ƒ
        })
        .padding({ right: 15 })
        .height('100%')
        // é¼ æ ‡æ‚¬åœå˜è‰²æ•ˆæœ(æ¨¡æ‹Ÿ)
        .onClick(() => {
          // ç‚¹å‡»å¼¹å‡ºæ—¥å†é€»è¾‘
        })

      }
      .width('100%')
      .height(48) // Win10 ä»»åŠ¡æ æ ‡å‡†é«˜åº¦çº¦ä¸º 40-50px
      .backgroundColor('rgba(30, 30, 30, 0.95)') // æ·±é»‘è‰²åº•ï¼Œç¨å¾®é€æ˜
      // .backgroundColor('#f3f3f3') // å¦‚æœä½ å–œæ¬¢æµ…è‰²ä¸»é¢˜ï¼Œå°±ç”¨è¿™ä¸ªæµ…ç°è‰²
      .position({ y: '100%' })
      .translate({ y: -48 }) // ä¿®æ­£ä½ç½®
      .alignItems(VerticalAlign.Center)
    }
  }

  // ==== ä¿®å¤ DockItem å®šä¹‰ ====
  // å¿…é¡»æ¥æ”¶ (bundleName, icon) ä¸¤ä¸ªå‚æ•°ï¼Œæ‰èƒ½å’Œä¸Šé¢çš„è°ƒç”¨åŒ¹é…
  @Builder DockItem(bundleName: string, icon: Resource): void {
    Column() {
      Image(icon)
        .width(45)
        .height(45)
        .borderRadius(10)
        .backgroundColor('white') // åŠ ä¸ªç™½åº•ï¼Œé˜²æ­¢é€æ˜å›¾æ ‡çœ‹ä¸è§
        .padding(5)
    }
    .width(55)
    .height(55)
    .justifyContent(FlexAlign.Center)
    .margin({ left: 5, right: 5 })
    .onClick(() => {
      // æ„é€ ä¸€ä¸ªä¸´æ—¶çš„ item ä¼ ç»™å¯åŠ¨å‡½æ•°
      this.launchApp({ name: bundleName, label: 'DockApp', icon: icon });
    })
  }

  // å¯åŠ¨åº”ç”¨é€»è¾‘
  launchApp(item: AppItem): void {
    console.info(`å°è¯•å¯åŠ¨: ${item.label} (${item.name})`);
    if (item.name === 'distributed.center') {
      this.distController.open(); // ç›´æ¥æ‰“å¼€é›·è¾¾å›¾
      return;
    }

    if (item.name.startsWith('mock.')) {
      AlertDialog.show({ message: `[æ¼”ç¤º] æ¨¡æ‹Ÿå¯åŠ¨: ${item.label}` });
      return;
    }

    let want: Want = {
      bundleName: item.name,
      abilityName: item.abilityName
    };

    this.context.startAbility(want).catch((err: BusinessError) => {
      console.error(`å¯åŠ¨å¤±è´¥: ${err.message}`);
      // å¤±è´¥é‡è¯•
      let wantBackup: Want = { bundleName: item.name };
      this.context.startAbility(wantBackup).catch((err2: BusinessError) => {
        AlertDialog.show({ message: `å¯åŠ¨å¤±è´¥: ${item.label}\n${err2.message}` });
      });
    });
  }
}